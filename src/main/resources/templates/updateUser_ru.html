<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org/" style="background-color: #ffffff">
<head>
    <meta charset="UTF-8">
    <link th:href="@{/css/login.css}" rel="stylesheet"  type="text/css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="/img/mini_logo.png" type="image/x-icon">
    <title>Изменение данных аккаунта</title>
</head>
<body>
<div class="wrapper fadeInDown">
    <div id="formContent">
        <h2 class="active"> Измените некоторые данные </h2>

        <div id="result_msg"></div>
        <input type="text" id="fname" class="fadeIn third" value="" name="login" required>
        <input type="text" id="lname" class="fadeIn third" value="" name="login" placeholder="фамилия" required>
        <input type="number" id="age" class="fadeIn third" value="" name="login" min="18" required>
        <select name="login" id="gender" class="fadeIn third" required>
            <option value="">- пол -</option>
            <option value="Male">Мужчина</option>
            <option value="Female">Женщина</option>
        </select>
        <select name="login" id="city" class="fadeIn third" required>
            <option value="">- город -</option>
            <option value="Astana">Астана</option>
            <option value="Almaty">Алматы</option>
            <option value="Shymkent">Шымкент</option>
            <option value="Aktobe">Актобе</option>
            <option value="Karaganda">Караганды</option>
            <option value="Atyrau">Атырау</option>
            <option value="Taraz">Тараз</option>
            <option value="Pavlodar">Павлодар</option>
            <option value="Semey">Семей</option>
            <option value="Ust-Kamenogorsk">Усть-Каменогорск</option>
            <option value="Kyzylorda">Кызылорда</option>
            <option value="Uralsk">Уральск</option>
            <option value="Kostanay">Костанай</option>
            <option value="Petropavlsk">Петропавльск</option>
            <option value="Taldykorgan">Талдыкорган</option>
            <option value="Kokshetau">Кокшетау</option>
        </select>
        <button type="submit" id="editButton" class="fadeIn fourth button">Изменить</button>

    </div>
</div>
</body>

<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript">
    if (getCookie("Authorization") == null) {
        window.location.replace("/loginUser");
    }

    let user_info;

    function parseJwt(token) {
        let base64Url = token.split('.')[1];
        let base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        let jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function eraseCookie(name) {
        document.cookie = name + '=; Max-Age=-99999999;';
    }

    $(document).ready(function () {
            let myCookie = getCookie("Authorization");

            if (getCookie("Authorization") != null) {
                let resultC = parseJwt(myCookie);
                let email = resultC.sub;

                $.ajax({
                    type: "GET",
                    headers: {'Authorization': myCookie},
                    contentType: 'application/json',
                    url: "getUser",
                    data: {email: email},
                    dataType: 'json',
                    success: function (result) {
                        user_info = result;
                        console.log(result);
                        $('#email').val(result.email);
                        $('#fname').val(result.first_name);
                        $('#lname').val(result.last_name);
                        $('#age').val(result.age);
                        $('#city').val(result.city);
                        $('#gender').val(result.gender);
                    },
                    error: function (e) {
                        console.log("ERROR: ", e);
                        window.location.replace("/loginUser");
                    }
                });
            } else {
                window.location.replace("/loginUser");
            }

            $('#editButton').on('click', function () {
                let resultC = parseJwt(myCookie)
                let email = resultC.sub
                let fname = $('#fname').val();
                let lname = $('#lname').val();
                let age = $('#age').val();
                let gender = $('#gender').val();
                let city = $('#city').val();
                $.ajax({
                    type: "POST",
                    headers: {'Authorization': myCookie},
                    contentType: 'application/json',
                    url: "updateProfile",
                    data: JSON.stringify({
                        email: email, first_name: fname,
                        last_name: lname, age: age, gender: gender, city: city
                    }),
                    dataType: 'json',
                    complete: function (result) {
                        console.log(result.responseText);
                        if (result.responseText == "User successfully updated") {
                            //console.log(123);
                            window.location.replace("/profile");
                        } else {
                            $('#result_msg').css("border", "1px solid red")
                            $('#result_msg').html(result.responseText);
                        }
                    }
                })
            })



        }
    );
</script>
</html>